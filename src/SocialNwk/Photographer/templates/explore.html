{% extends "base.html" %}
{% load staticfiles %}
{% block title %}EXPLORE{% endblock %}
{% block head_script %}
    <link href="{% static 'explore_main.css' %}" rel="stylesheet" type="text/css">
{% endblock %}
{% block content %}
    <div id="container">
        
    <div id="main" role="main">

      <ul id="tiles">
        <!-- Place content loaded photo from the photo API -->
      </ul>

    </div>

    </div>
    <div id="loadMore"><a>Load More</a></div>
{% endblock %}

{% block foot_script %}
<!--<script src="{% static 'tuolei.js' %}"></script>-->
<script>
    /*photo_list_url = "{% url 'photo:photo-list' %}";
    photo_page_url = "{% url 'photo:photo_page' 1 %}";
    user_url = "{% url 'photo:user_page' 1 %}";
    user_url = user_url.substring(0, user_url.length - 2);
    photo_page_url = photo_page_url.substring(0, photo_page_url.length - 2);
    
     $(document).ready(function(){
        //loadPhotos();
        loadData();
    }) */

</script>

<!-- Include the imagesLoaded plug-in -->
  <script src="{% static 'jquery.imagesloaded.js' %}"></script>

<!-- Include the plug-in -->
  <script src="{% static 'jquery.wookmark.js' %}"></script>

<!-- Once the page is loaded, initalize the plug-in. -->
  <script type="text/javascript">
    //var photo_list_url = "/api/photos/";

    (function ($) {
      var handler = null,
          page = 1,
          isLoading = false,
          finishLoad = false,
          apiURL = '/api/photos/';

      // Prepare layout options.
      var options = {
        autoResize: true, // This will auto-update the layout when the browser window is resized.
        container: $('#tiles'), // Optional, used for some extra CSS styling
        offset: 2, // Optional, the distance between grid items
        itemWidth: 210 // Optional, the width of a grid item
      };

      /**
       * When scrolled all the way to the bottom, add more tiles.
       */
      function onScroll(event) {

        // Only check when we're not still waiting for data.
        if(!isLoading && !finishLoad) {
          // Check if we're within 100 pixels of the bottom edge of the broser window.
          var closeToBottom = ($(window).scrollTop() + $(window).height() > $(document).height() - 100);
          if(closeToBottom) {
            loadData();
          }
        }
      };

      /**
       * Refreshes the layout.
       */
      function applyLayout() {
        options.container.imagesLoaded(function() {
          // Create a new layout handler when images have loaded.
          handler = $('#tiles li');
          handler.wookmark(options);
        });
      };

      /**
       * Loads data from the API.
       */
      function loadData() {
        isLoading = true;

        $.ajax({
          type: 'GET',
          url: apiURL,
          dataType: 'json',
          //data: {page: page}, // Page parameter to make sure we load new data
          //success: onLoadData
        }).success(function(data, textStatus, jqXHR){
        
            isLoading = false;
            $.each(data.results, function(i, item) {
                var html = '';
                html += '<li>';
                html += '<img src="'+ item.file +'" width="200">';
                html += '<p>'+item.title+'</p>';
                html += '<p>'+item.authorName+'</p>';

                html += '</li>';

                console.log("html:" + html);

                $("#tiles").append(html);
                applyLayout();
            });
            if(data.next){
                apiURL = data.next;
                //$('#loadMore a').off('click');
                //$('#loadMore a').click(loadData);
            }else{
                finishLoad = true;
                //$('#loadMore a').off('click');
                $('#loadMore').html('No more photos')
            }
        }).fail(function( jqXHR, textStatus ) {
            alert('Request Failed');
        });

    }

      /**
       * Receives data from the API, creates HTML for images and updates the layout
       */
      /*function onLoadData(data) {

        console.log("data:"+ data);
        isLoading = false;
        //$('#loaderCircle').hide();

        // Increment page index for future calls.
        page++;
        console.log("page:"+ page);

        // Create HTML for the images.
        var html = '';
        var i=0, length=data.length, image;

        onsole.log("data length:"+ data.length);


        for(; i<length; i++) {
          image = data[i];

console.log("image data:"+ image.url);

          html += '<li> in it ';

          // Image tag (preview in Wookmark are 200px wide, so we calculate the height based on that).
          html += '<img src="'+image.url+'" width="200" height="'+Math.round(image.height/image.width*200)+'">';

          // Image title.
          html += '<p>'+image.title+'</p>';

          html += '</li>';
        }

        // Add image HTML to the page.
        $('#tiles').append(html);

        // Apply layout.
        applyLayout();
      };*/

      // Capture scroll event.
      $(document).bind('scroll', onScroll);

      // Load first data from the API.
      loadData();
    })(jQuery);
  </script>

{% endblock %}